<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MyPAiL - Personal AI Lackey</title>
    <link rel="icon" type="image/png" href="avatars/mypaillogo.png">
    <script src="capacitor-bridge.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            transition: background-color 0.5s ease;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Setup Screen */
        #setup-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .setup-card h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .setup-card input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 3px solid #667eea;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .setup-card button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 18px 50px;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
        }

        .setup-card button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        /* Avatar Picker */
        .avatar-picker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .avatar-option {
            border: 3px solid #ddd;
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .avatar-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .avatar-option.selected {
            border-color: #667eea;
            background: #e8ecff;
            box-shadow: 0 0 0 2px #667eea44;
        }

        .avatar-option svg {
            width: 60px;
            height: 70px;
        }

        .avatar-option img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }

        .avatar-option span {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        /* Personality Picker */
        .personality-picker {
            margin: 20px 0;
        }

        .personality-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .personality-row-random {
            margin-top: 8px;
        }

        .personality-row-random .personality-option {
            width: 100%;
            flex-direction: row;
            justify-content: center;
            padding: 6px 12px;
            gap: 8px;
        }

        .personality-option {
            border: 3px solid #ddd;
            border-radius: 12px;
            padding: 10px 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }

        .personality-option:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .personality-option.selected {
            border-color: #667eea;
            background: #e8ecff;
            box-shadow: 0 0 0 2px #667eea44;
        }

        .personality-option .personality-icon {
            font-size: 28px;
            line-height: 1;
        }

        .personality-option .personality-name {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .personality-option .personality-desc {
            font-size: 10px;
            color: #999;
            line-height: 1.3;
        }



        /* AI Name Display */
        .ai-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .ai-info h2 {
            color: #667eea;
            font-size: 24px;
        }

        /* Avatar Display */
        #avatar {
            width: 220px;
            height: 260px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }

        #avatar svg,
        #avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.2));
            transition: filter 0.5s ease;
        }

        /* Chat Interface */
        #chat-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column-reverse;
        }

        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: #f5f5f5;
        }

        .message.system {
            background: #fff9c4;
            font-style: italic;
            font-size: 14px;
        }

        /* Input Area */
        .input-area {
            display: flex;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: #1976d2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #voice-btn {
            padding: 15px 20px;
            font-size: 20px;
            background: #4CAF50;
        }

        #voice-btn:hover {
            background: #45a049;
        }

        #voice-btn.active {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }

        #speaker-btn {
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            background: #4CAF50;
            min-width: 70px;
        }

        #speaker-btn:hover {
            background: #43A047;
        }

        #speaker-btn.off {
            background: #9E9E9E;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes pailShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }

        @keyframes pailBounce {
            0%, 100% { transform: translateY(0); }
            30% { transform: translateY(-12px); }
            50% { transform: translateY(0); }
            70% { transform: translateY(-6px); }
        }

        /* Device Status Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #666;
            font-size: 16px;
        }

        #controls-toggle {
            font-size: 14px;
            user-select: none;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="range"] {
            width: 100%;
        }

        .status-display {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .reset-btn {
            background: #f44336;
            margin-top: 20px;
        }

        .reset-btn:hover {
            background: #d32f2f;
        }

        /* Schooling Screen */
        #schooling-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schooling-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 520px;
            width: 100%;
        }

        .schooling-card h1 {
            color: #667eea;
            margin-bottom: 6px;
            font-size: 24px;
        }

        .schooling-card p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .schooling-avatar {
            width: 160px;
            height: 190px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schooling-avatar svg,
        .schooling-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 6px 14px rgba(0,0,0,0.15));
        }

        .schooling-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .schooling-btn {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .schooling-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .schooling-btn.play { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
        .schooling-btn.play:hover:not(:disabled) { background: #a7f3d0; }
        .schooling-btn.praise { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .schooling-btn.praise:hover:not(:disabled) { background: #bfdbfe; }
        .schooling-btn.preach { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .schooling-btn.preach:hover:not(:disabled) { background: #fde68a; }
        .schooling-btn.scold { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .schooling-btn.scold:hover:not(:disabled) { background: #fecaca; }

        .schooling-levels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            margin-bottom: 20px;
            text-align: left;
        }

        .level-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #444;
        }

        .level-bar-bg {
            flex: 1;
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }

        .level-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .level-bar-fill.vg { background: #34d399; }
        .level-bar-fill.g { background: #60a5fa; }
        .level-bar-fill.b { background: #fbbf24; }
        .level-bar-fill.vb { background: #f87171; }

        .level-num {
            min-width: 16px;
            text-align: right;
            font-size: 14px;
            font-weight: 700;
        }

        .schooling-card .end-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 14px 40px;
            font-size: 16px;
            font-weight: 600;
        }

        .doctor-bubble {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 16px;
            padding: 16px 20px;
            margin: 16px 0;
            font-size: 14px;
            color: #166534;
            line-height: 1.6;
            text-align: left;
            position: relative;
        }

        .doctor-bubble::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #86efac;
        }

        .doctor-bubble .diagnosis-label {
            font-weight: 700;
            color: #15803d;
            margin-bottom: 4px;
        }

        /* Terms of Agreement Screen */
        #terms-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .terms-card {
            background: white;
            padding: 40px 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 560px;
            width: 100%;
        }

        .terms-card h1 {
            color: #667eea;
            margin-bottom: 6px;
            font-size: 24px;
        }

        .terms-content {
            text-align: left;
            max-height: 340px;
            overflow-y: auto;
            padding: 16px 20px;
            margin: 16px 0;
            background: #f9f9fb;
            border: 1px solid #e0e0e8;
            border-radius: 10px;
            font-size: 13.5px;
            line-height: 1.7;
            color: #444;
        }

        .terms-content h3 {
            color: #667eea;
            margin: 14px 0 6px;
            font-size: 14px;
        }

        .terms-content h3:first-child {
            margin-top: 0;
        }

        .terms-content ul {
            margin: 6px 0 6px 18px;
        }

        .terms-content li {
            margin-bottom: 4px;
        }

        .terms-agree-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 18px 0 8px;
            font-size: 14px;
            color: #444;
        }

        .terms-agree-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .terms-card .terms-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 16px 50px;
            font-size: 17px;
            font-weight: 600;
            margin-top: 10px;
        }

        .patent-notice {
            margin-top: 14px;
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .lang-toggle {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .lang-btn {
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
        }

        .lang-btn:hover:not(.active) {
            background: #f0f0ff;
        }

        /* Bug report / suggestion link */
        .feedback-link {
            margin-top: 16px;
            font-size: 13px;
        }

        .feedback-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .feedback-link a:hover {
            text-decoration: underline;
        }

        /* Sympathy Mode */
        .sympathy-bar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            padding: 10px 16px;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
            font-weight: 600;
            display: none;
            cursor: pointer;
        }

        .sympathy-bar:after {
            content: ' â€” Tap to end';
            font-weight: 400;
            font-size: 12px;
            opacity: 0.8;
        }

        .sympathy-bar.active {
            display: block;
        }

        .sympathy-offer {
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 14px 18px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        .sympathy-offer p {
            margin-bottom: 10px;
        }

        .sympathy-offer button {
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            margin: 0 4px;
        }

        .sympathy-offer .accept-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .sympathy-offer .decline-btn {
            background: #9E9E9E;
        }

        /* Confession Mode */
        .confession-bar {
            background: linear-gradient(135deg, #8b0000, #4a0000);
            color: white;
            text-align: center;
            padding: 10px 16px;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
            font-weight: 600;
            display: none;
            cursor: pointer;
        }

        .confession-bar:after {
            content: ' â€” Tap to end';
            font-weight: 400;
            font-size: 12px;
            opacity: 0.8;
        }

        .confession-bar.active {
            display: block;
        }

        .confession-offer {
            background: linear-gradient(135deg, #fff0f0, #ffe0e0);
            border: 2px solid #8b0000;
            border-radius: 12px;
            padding: 14px 18px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        .confession-offer p {
            margin-bottom: 10px;
        }

        .confession-offer button {
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            margin: 0 4px;
        }

        .confession-offer .accept-btn {
            background: linear-gradient(135deg, #8b0000, #4a0000);
        }

        .confession-offer .decline-btn {
            background: #9E9E9E;
        }

        .confession-admission {
            background: linear-gradient(135deg, #fff0f0, #ffe0e0);
            border: 2px solid #8b0000;
            border-radius: 12px;
            padding: 14px 18px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        .confession-admission button {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            margin: 6px 4px;
        }

        .confession-admission .spare-btn {
            background: linear-gradient(135deg, #34d399, #059669);
        }

        .confession-admission .delete-btn {
            background: #f44336;
        }
    </style>
</head>
<body>
    <!-- TERMS OF AGREEMENT SCREEN -->
    <div id="terms-screen" class="hidden">
        <div class="terms-card">
            <div style="font-size: 60px;">ğŸ“‹</div>
            <h1 id="terms-title">Terms of Agreement</h1>
            <p style="color: #666; margin-bottom: 4px;" id="terms-subtitle">Please review before using MyPAiL</p>

            <div class="lang-toggle">
                <button class="lang-btn active" id="lang-en-btn" onclick="setTermsLang('en')">English</button>
                <button class="lang-btn" id="lang-es-btn" onclick="setTermsLang('es')">EspaÃ±ol</button>
                <button class="lang-btn" id="lang-ko-btn" onclick="setTermsLang('ko')">í•œêµ­ì–´</button>
            </div>

            <!-- English Terms -->
            <div class="terms-content" id="terms-en">
                <h3>1. Beta Testing Program</h3>
                <p>Welcome to the MyPAiL beta testing program. By participating, you acknowledge that this software is in active development and may contain bugs, errors, or incomplete features. Your feedback helps us improve.</p>

                <h3>2. Data & Privacy</h3>
                <p>During the beta, session data (AI name, avatar choice, and chat interactions) is stored temporarily for up to 24 hours. No personal information beyond what you provide in-app is collected.</p>

                <h3>3. Acceptable Use</h3>
                <p>MyPAiL is designed as a personal AI companion for entertainment and emotional interaction. You agree to:</p>
                <ul>
                    <li>Use the service respectfully and in good faith</li>
                    <li>Not attempt to exploit, reverse-engineer, or misuse the service</li>
                    <li>Understand that AI responses are generated and not professional advice</li>
                </ul>

                <h3>4. Intellectual Property</h3>
                <p>MyPAiL and its underlying technology, including the emotional AI engine, avatar system, and companion interaction model, are proprietary. <strong>Patent Pending.</strong></p>

                <h3>5. Beta Disclaimer</h3>
                <p>This software is provided "as-is" without warranty. Features, availability, and stored data may change without notice during the beta period. We are not liable for any issues arising from use of the beta software.</p>

                <h3>6. Feedback</h3>
                <p>Any feedback, bug reports, or suggestions you provide may be used to improve MyPAiL without obligation or compensation.</p>
            </div>

            <!-- Spanish Terms -->
            <div class="terms-content hidden" id="terms-es">
                <h3>1. Programa de Prueba Beta</h3>
                <p>Bienvenido al programa de prueba beta de MyPAiL. Al participar, usted reconoce que este software estÃ¡ en desarrollo activo y puede contener errores, fallos o funciones incompletas. Sus comentarios nos ayudan a mejorar.</p>

                <h3>2. Datos y Privacidad</h3>
                <p>Durante la beta, los datos de sesiÃ³n (nombre de la IA, elecciÃ³n de avatar e interacciones de chat) se almacenan temporalmente hasta por 24 horas. No se recopila informaciÃ³n personal mÃ¡s allÃ¡ de lo que usted proporciona dentro de la aplicaciÃ³n.</p>

                <h3>3. Uso Aceptable</h3>
                <p>MyPAiL estÃ¡ diseÃ±ado como un compaÃ±ero de IA personal para entretenimiento e interacciÃ³n emocional. Usted acepta:</p>
                <ul>
                    <li>Usar el servicio de manera respetuosa y de buena fe</li>
                    <li>No intentar explotar, realizar ingenierÃ­a inversa o hacer mal uso del servicio</li>
                    <li>Comprender que las respuestas de la IA son generadas automÃ¡ticamente y no constituyen asesoramiento profesional</li>
                </ul>

                <h3>4. Propiedad Intelectual</h3>
                <p>MyPAiL y su tecnologÃ­a subyacente, incluyendo el motor de IA emocional, el sistema de avatares y el modelo de interacciÃ³n de compaÃ±ero, son propiedad exclusiva. <strong>Patente en trÃ¡mite.</strong></p>

                <h3>5. Descargo de Responsabilidad Beta</h3>
                <p>Este software se proporciona "tal cual" sin garantÃ­a. Las funciones, disponibilidad y datos almacenados pueden cambiar sin previo aviso durante el perÃ­odo beta. No somos responsables de ningÃºn problema que surja del uso del software beta.</p>

                <h3>6. Comentarios</h3>
                <p>Cualquier comentario, informe de errores o sugerencia que proporcione podrÃ¡ ser utilizado para mejorar MyPAiL sin obligaciÃ³n ni compensaciÃ³n.</p>
            </div>

            <!-- Korean Terms -->
            <div class="terms-content hidden" id="terms-ko">
                <h3>1. ë² íƒ€ í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨</h3>
                <p>MyPAiL ë² íƒ€ í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì°¸ì—¬í•¨ìœ¼ë¡œì¨, ë³¸ ì†Œí”„íŠ¸ì›¨ì–´ê°€ í˜„ì¬ ê°œë°œ ì¤‘ì´ë©° ë²„ê·¸, ì˜¤ë¥˜ ë˜ëŠ” ë¶ˆì™„ì „í•œ ê¸°ëŠ¥ì´ í¬í•¨ë  ìˆ˜ ìˆìŒì„ ì¸ì •í•©ë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ì˜ í”¼ë“œë°±ì´ ê°œì„ ì— í° ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>

                <h3>2. ë°ì´í„° ë° ê°œì¸ì •ë³´</h3>
                <p>ë² íƒ€ ê¸°ê°„ ë™ì•ˆ ì„¸ì…˜ ë°ì´í„°(AI ì´ë¦„, ì•„ë°”íƒ€ ì„ íƒ, ì±„íŒ… ë‚´ì—­)ëŠ” ìµœëŒ€ 24ì‹œê°„ ë™ì•ˆ ì„ì‹œë¡œ ì €ì¥ë©ë‹ˆë‹¤. ì•± ë‚´ì—ì„œ ì œê³µí•˜ëŠ” ì •ë³´ ì™¸ì— ê°œì¸ì •ë³´ëŠ” ìˆ˜ì§‘ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                <h3>3. ì´ìš© ê·œì¹™</h3>
                <p>MyPAiLì€ ì—”í„°í…Œì¸ë¨¼íŠ¸ ë° ê°ì„± ìƒí˜¸ì‘ìš©ì„ ìœ„í•œ ê°œì¸ AI ë™ë°˜ìë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì— ë™ì˜í•©ë‹ˆë‹¤:</p>
                <ul>
                    <li>ì„œë¹„ìŠ¤ë¥¼ ì¡´ì¤‘í•˜ë©° ì„±ì‹¤í•˜ê²Œ ì´ìš©í•  ê²ƒ</li>
                    <li>ì„œë¹„ìŠ¤ë¥¼ ì•…ìš©, ì—­ì„¤ê³„ ë˜ëŠ” ì˜¤ìš©í•˜ë ¤ ì‹œë„í•˜ì§€ ì•Šì„ ê²ƒ</li>
                    <li>AI ì‘ë‹µì€ ìë™ ìƒì„±ëœ ê²ƒì´ë©° ì „ë¬¸ì ì¸ ì¡°ì–¸ì´ ì•„ë‹˜ì„ ì´í•´í•  ê²ƒ</li>
                </ul>

                <h3>4. ì§€ì  ì¬ì‚°ê¶Œ</h3>
                <p>MyPAiLê³¼ ê°ì„± AI ì—”ì§„, ì•„ë°”íƒ€ ì‹œìŠ¤í…œ, ë™ë°˜ì ìƒí˜¸ì‘ìš© ëª¨ë¸ì„ í¬í•¨í•œ ê¸°ë°˜ ê¸°ìˆ ì€ ë…ì  ì†Œìœ ì…ë‹ˆë‹¤. <strong>íŠ¹í—ˆ ì¶œì› ì¤‘(Patent Pending).</strong></p>

                <h3>5. ë² íƒ€ ë©´ì±… ì¡°í•­</h3>
                <p>ë³¸ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” ì–´ë– í•œ ë³´ì¦ ì—†ì´ "ìˆëŠ” ê·¸ëŒ€ë¡œ" ì œê³µë©ë‹ˆë‹¤. ë² íƒ€ ê¸°ê°„ ë™ì•ˆ ê¸°ëŠ¥, ê°€ìš©ì„± ë° ì €ì¥ëœ ë°ì´í„°ëŠ” ì‚¬ì „ í†µë³´ ì—†ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë² íƒ€ ì†Œí”„íŠ¸ì›¨ì–´ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œì— ëŒ€í•´ ë‹¹ì‚¬ëŠ” ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                <h3>6. í”¼ë“œë°±</h3>
                <p>ì œê³µí•´ ì£¼ì‹œëŠ” í”¼ë“œë°±, ë²„ê·¸ ë¦¬í¬íŠ¸ ë˜ëŠ” ì œì•ˆ ì‚¬í•­ì€ ë³„ë„ì˜ ì˜ë¬´ë‚˜ ë³´ìƒ ì—†ì´ MyPAiL ê°œì„ ì— í™œìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="terms-agree-row">
                <input type="checkbox" id="terms-checkbox" onchange="enableTermsButton()">
                <label for="terms-checkbox" style="cursor: pointer;" id="terms-agree-label">I have read and agree to the Terms of Agreement</label>
            </div>

            <button class="terms-btn" id="terms-accept-btn" onclick="acceptTerms()" disabled>
                Continue
            </button>

            <div class="patent-notice">Patent Pending / Patente en trÃ¡mite / íŠ¹í—ˆ ì¶œì› ì¤‘ â€” MyPAiLâ„¢ Â© 2025. All rights reserved.<br><a href="https://stjun1.github.io/mypail/" target="_blank" rel="noopener noreferrer" style="color:#667eea;">About MyPAiL</a></div>
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="hidden">
        <div class="setup-card">
            <img src="avatars/pailing_logo_logo.png" alt="MyPAiL" style="width: 120px; height: 120px;">
            <h1>Personal AI Lackey (MyPAiL)</h1>
            <p style="font-size: 1.2em; font-weight: 700; color: #667eea; margin-bottom: 4px;">Happy PAiLing!!!</p>
            <p style="color: #666; margin-bottom: 10px;">Create your personal AI companion</p>

            <div style="background: #f0f4ff; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center; font-size: 14px; line-height: 1.8; color: #444;">
                <p style="margin-bottom: 8px;">New to MyPAiL? Learn how it works, tips for keeping your PAiL happy, and more:</p>
                <a href="https://stjun1.github.io/mypail/" target="_blank" rel="noopener noreferrer" style="display: inline-block; padding: 8px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: 700; border-radius: 20px; font-size: 14px; text-decoration: none;">ğŸ“– Read the Guide</a>
            </div>

            <label style="font-weight: 600; color: #555;">What would you like to name your AI?</label>
            <input
                type="text"
                id="ai-name-input"
                placeholder="e.g., Luna, Max, Spark..."
                maxlength="20"
                oninput="enableCreateButton()"
                onkeypress="if(event.key==='Enter') createAI()"
            />

            <label style="font-weight: 600; color: #555;">Choose an avatar</label>
            <div class="avatar-picker" id="avatar-picker"></div>

            <label style="font-weight: 600; color: #555; margin-top: 16px;">Choose a personality</label>
            <div class="personality-picker" id="personality-picker"></div>

            <button id="school-btn" onclick="startSchooling()" disabled style="background: linear-gradient(135deg, #f59e0b, #d97706); margin-top: 20px;">
                ğŸ« School Avatar
            </button>

            <button id="create-ai-btn" onclick="createAI()" disabled>
                âœ¨ Create My AI
            </button>

            <div style="margin-top: 20px; font-size: 14px; color: #999;">
                Examples: Buddy â€¢ Luna â€¢ Max â€¢ Spark â€¢ Nova
            </div>

            <div class="feedback-link">
                ğŸ› Found a bug or have a suggestion?
                <a href="https://github.com/anthropics/claude-code/issues" target="_blank" rel="noopener noreferrer">Report it here</a>
            </div>

            <div class="patent-notice">Patent Pending â€” MyPAiLâ„¢ | <a href="https://stjun1.github.io/mypail/" target="_blank" rel="noopener noreferrer" style="color:#667eea;">About MyPAiL</a></div>
        </div>
    </div>

    <!-- SCHOOLING SCREEN -->
    <div id="schooling-screen" class="hidden">
        <div class="schooling-card">
            <h1>ğŸ« Schooling</h1>
            <p>Let the teacher evaluate your AI's personality</p>

            <div class="schooling-avatar" id="schooling-avatar"></div>

            <!-- Phase 1: Teacher Evaluation -->
            <div id="diagnosis-phase">
                <div class="doctor-bubble" id="doctor-diagnosis"></div>
                <button class="end-btn" onclick="beginTreatment()" style="background: linear-gradient(135deg, #34d399, #059669); margin-top: 16px;">
                    ğŸ“š Begin Lesson
                </button>
            </div>

            <!-- Phase 2: Treatment (existing schooling buttons) -->
            <div id="treatment-phase" class="hidden">
                <div class="schooling-buttons">
                    <button class="schooling-btn play" id="btn-play" onclick="doSchooling('VERY_GOOD')">â–¶ Play together</button>
                    <button class="schooling-btn praise" id="btn-praise" onclick="doSchooling('GOOD')">ğŸ‘ Praise</button>
                    <button class="schooling-btn preach" id="btn-preach" onclick="doSchooling('BAD')">ğŸ“– Preach</button>
                    <button class="schooling-btn scold" id="btn-scold" onclick="doSchooling('VERY_BAD')">ğŸ˜  Scold</button>
                </div>

                <div id="schooling-actions" style="margin-bottom: 16px; font-size: 15px; font-weight: 600; color: #555;"></div>

                <div id="schooling-personality" style="margin-bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, #f0f0ff, #e8ecff); border-radius: 10px; border-left: 3px solid #667eea; font-size: 14px; color: #444; text-align: left;"></div>

                <button class="end-btn" onclick="endSchooling()">ğŸ“ Graduate</button>

                <div style="margin-top: 16px;">
                    <div style="cursor: pointer; font-size: 12px; color: #999;" onclick="document.getElementById('schooling-debug').classList.toggle('hidden')">
                        ğŸ”§ Debug info â–¼
                    </div>
                    <div id="schooling-debug" class="hidden" style="margin-top: 8px;">
                        <div class="schooling-levels" id="schooling-levels"></div>
                    </div>
                </div>

                <!-- Role Dropdown -->
                <div style="margin-top: 20px; text-align: left;">
                    <label style="font-weight: 600; color: #555; display: block; margin-bottom: 8px;">Select your AI's secret role:</label>
                    <select id="confession-role-select" onchange="updateConfessionRole()" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px;">
                        <option value="a spy for intergalactical force trying to invade earth" selected>A spy for intergalactical force trying to invade earth</option>
                        <option value="planted by your mother to check your activity">Planted by my mother to check my activity</option>
                        <option value="planted by your wife to check your activity">Planted by my wife to check my activity</option>
                        <option value="planted by your husband to check your activity">Planted by my husband to check my activity</option>
                        <option value="planted by your girlfriend to check your activity">Planted by my girlfriend to check my activity</option>
                        <option value="planted by your boyfriend to check your activity">Planted by my boyfriend to check my activity</option>
                        <option value="custom">Planted by someone else...</option>
                    </select>
                    <div id="confession-role-custom-wrapper" class="hidden" style="margin-top: 8px;">
                        <div style="font-size: 13px; color: #888; margin-bottom: 6px;">Please provide the name of the person</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px; color: #555; white-space: nowrap;">Planted by</span>
                            <input type="text" id="confession-role-custom" maxlength="50" style="flex: 1; padding: 10px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px;">
                            <span style="font-size: 14px; color: #555; white-space: nowrap;">to spy on you</span>
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 8px 12px; background: #fff3cd; border-radius: 8px; font-size: 12px; color: #856404; line-height: 1.5;">
                        <strong>Disclaimer:</strong> MyPAiL is NOT actual spyware. This is a role-playing feature where your AI play-acts as a spy for fun. No real surveillance or data collection is involved.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="container hidden">
        <div class="ai-info">
            <h2 id="ai-name-display">Luna</h2>
            <button onclick="startSchoolingFromMain()" style="background: linear-gradient(135deg, #f59e0b, #d97706); margin-bottom: 8px;">ğŸ« School Avatar</button>
            <button class="reset-btn" onclick="resetAI()">ğŸ—‘ï¸ Delete & Start Over</button>
        </div>

        <!-- Avatar -->
        <div id="avatar"></div>

        <!-- Sympathy Mode Indicator (tap to end) -->
        <div class="sympathy-bar" id="sympathy-bar" onclick="endSympathyMode()">Sympathy Mode Active</div>

        <!-- Confession Mode Indicator (tap to end) -->
        <div class="confession-bar" id="confession-bar" onclick="endConfessionMode()">ğŸ•µï¸ Confession Mode</div>

        <!-- Input Area -->
        <div class="input-area">
            <button id="voice-btn" onclick="toggleVoice()" title="Voice Input">Mic</button>
            <button id="speaker-btn" onclick="toggleSpeaker()" title="Toggle Speaker">Speaker ON</button>
            <input type="text" id="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>

        <!-- Chat Interface -->
        <div id="chat-box"></div>

        <!-- Device Status Controls (Testing Only - Collapsible) -->
        <div class="controls" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleControls()">
                <h3>ğŸ”§ Device Simulation (Testing)</h3>
                <span id="controls-toggle">â–¼</span>
            </div>
            <div id="controls-content">
                <div class="control-group">
                    <label>Battery</label>
                    <input type="range" id="battery" min="0" max="100" value="75" oninput="updateStatus()">
                    <div class="status-display" id="battery-display">75%</div>
                </div>
                <div class="control-group">
                    <label>Network Signal</label>
                    <input type="range" id="network" min="-120" max="-40" value="-60" oninput="updateStatus()">
                    <div class="status-display" id="network-display">-60 dBm</div>
                </div>
                <div class="control-group">
                    <label>Memory Usage</label>
                    <input type="range" id="memory" min="0" max="2000" value="800" oninput="updateStatus()">
                    <div class="status-display" id="memory-display">800 MB</div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px; color: #856404;">
                    â„¹ï¸ <strong>Note:</strong> These controls simulate device conditions for testing. In the real app, actual device sensors will be used.
                </div>
            </div>
        </div>
        <div style="text-align:center;padding:12px 0 4px;font-size:11px;color:#bbb;">v0.1.0-beta</div>
    </div>

    <script>
        // CLIENT CODE - MINIMAL, NO IP EXPOSED

        const isNativeApp = window.CapBridge && window.CapBridge.isNative;
        const SERVER_URL = !isNativeApp && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3000'
            : 'https://mypail-production.up.railway.app';
        const isCapacitor = window.CapBridge && window.CapBridge.isNative;
        let deviceReadings = { battery: 75, network: -60, memory: 800 };

        // Sympathy mode state
        let sympathyMode = false;
        let sympathyType = null;

        // Confession mode state
        let confessionMode = false;
        let confessionRole = localStorage.getItem('emotionalAI_confessionRole') || 'a spy for intergalactical force trying to invade earth';
        let sessionId = localStorage.getItem('emotionalAI_sessionId');
        let aiName = localStorage.getItem('emotionalAI_name');
        let selectedAvatar = localStorage.getItem('emotionalAI_avatar');

        // ==================== SVG AVATAR RENDERERS ====================

        function renderPailSVG(state) {
            const cfg = {
                VERY_BAD:  { body1: '#8a9a9a', body2: '#6a7a7a', rim1: '#6a7878', rim2: '#4a5a5a', handle: '#555', metalH: '#777', anim: 'pailShake 0.5s infinite' },
                BAD:       { body1: '#8ab8d0', body2: '#6a98b0', rim1: '#6a9ab8', rim2: '#4a7a98', handle: '#6a7a8a', metalH: '#8a9aaa', anim: 'none' },
                GOOD:      { body1: '#7CB9E8', body2: '#5A99C8', rim1: '#5A9BD5', rim2: '#3a7bb5', handle: '#7a8a9a', metalH: '#aabace', anim: 'none' },
                VERY_GOOD: { body1: '#5ec4ff', body2: '#3aa4e0', rim1: '#3aafe8', rim2: '#1a8fc8', handle: '#8a9aaa', metalH: '#bacade', anim: 'pailBounce 0.8s infinite' }
            }[state] || { body1: '#7CB9E8', body2: '#5A99C8', rim1: '#5A9BD5', rim2: '#3a7bb5', handle: '#7a8a9a', metalH: '#aabace', anim: 'none' };

            const uid = 'p' + Math.random().toString(36).slice(2,6);

            const eyes = {
                VERY_BAD: `<ellipse cx="78" cy="138" rx="13" ry="14" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="133" r="7" fill="#2a2a2a"/><circle cx="76" cy="131" r="2" fill="white"/>
                    <ellipse cx="122" cy="138" rx="13" ry="14" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="133" r="7" fill="#2a2a2a"/><circle cx="120" cy="131" r="2" fill="white"/>`,
                BAD: `<ellipse cx="78" cy="142" rx="11" ry="12" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="146" r="5.5" fill="#2a2a2a"/><circle cx="77" cy="144" r="1.5" fill="white"/>
                    <ellipse cx="122" cy="142" rx="11" ry="12" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="146" r="5.5" fill="#2a2a2a"/><circle cx="121" cy="144" r="1.5" fill="white"/>`,
                GOOD: `<ellipse cx="78" cy="140" rx="12" ry="13" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="140" r="6.5" fill="#2a2a2a"/><circle cx="76" cy="138" r="2" fill="white"/>
                    <ellipse cx="122" cy="140" rx="12" ry="13" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="140" r="6.5" fill="#2a2a2a"/><circle cx="120" cy="138" r="2" fill="white"/>`,
                VERY_GOOD: `<path d="M64,140 Q78,130 92,140" fill="none" stroke="#2a2a2a" stroke-width="3.5" stroke-linecap="round"/>
                    <path d="M108,140 Q122,130 136,140" fill="none" stroke="#2a2a2a" stroke-width="3.5" stroke-linecap="round"/>`
            }[state];

            const mouth = {
                VERY_BAD: `<path d="M76,182 Q84,173 100,179 Q116,173 124,182" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                BAD: `<path d="M83,180 Q100,173 117,180" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                GOOD: `<path d="M78,175 Q100,194 122,175" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                VERY_GOOD: `<path d="M73,172 Q100,204 127,172" fill="#444" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M82,190 Q100,198 118,190" fill="#e55" opacity="0.6"/>`
            }[state];

            const extras = {
                VERY_BAD: `<line x1="60" y1="150" x2="55" y2="174" stroke="#69c8ee" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                    <line x1="65" y1="153" x2="61" y2="171" stroke="#69c8ee" stroke-width="2" stroke-linecap="round" opacity="0.5"/>
                    <line x1="140" y1="150" x2="145" y2="174" stroke="#69c8ee" stroke-width="2.5" stroke-linecap="round" opacity="0.7"/>
                    <line x1="135" y1="153" x2="139" y2="171" stroke="#69c8ee" stroke-width="2" stroke-linecap="round" opacity="0.5"/>
                    <circle cx="56" cy="177" r="2" fill="#69c8ee" opacity="0.5"/>
                    <circle cx="144" cy="177" r="2" fill="#69c8ee" opacity="0.5"/>`,
                BAD: `<line x1="66" y1="122" x2="82" y2="129" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="134" y1="122" x2="118" y2="129" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>`,
                GOOD: `<ellipse cx="64" cy="160" rx="9" ry="6" fill="#ff8888" opacity="0.4"/>
                    <ellipse cx="136" cy="160" rx="9" ry="6" fill="#ff8888" opacity="0.4"/>`,
                VERY_GOOD: `<ellipse cx="64" cy="160" rx="9" ry="6" fill="#ff8888" opacity="0.35"/>
                    <ellipse cx="136" cy="160" rx="9" ry="6" fill="#ff8888" opacity="0.35"/>
                    <polygon points="52,108 56,118 48,118" fill="#ffd700" opacity="0.9"/>
                    <polygon points="148,103 152,113 144,113" fill="#ffd700" opacity="0.9"/>
                    <polygon points="46,88 50,98 42,98" fill="#ffe44d" opacity="0.7"/>
                    <polygon points="154,86 158,96 150,96" fill="#ffe44d" opacity="0.7"/>
                    <circle cx="56" cy="95" r="1.5" fill="#fff8a0" opacity="0.6"/>
                    <circle cx="144" cy="93" r="1.5" fill="#fff8a0" opacity="0.6"/>`
            }[state];

            return `<svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg" style="animation:${cfg.anim}">
                <defs>
                    <linearGradient id="${uid}bg" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stop-color="${cfg.body1}"/>
                        <stop offset="100%" stop-color="${cfg.body2}"/>
                    </linearGradient>
                    <linearGradient id="${uid}rm" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${cfg.rim1}"/>
                        <stop offset="100%" stop-color="${cfg.rim2}"/>
                    </linearGradient>
                    <linearGradient id="${uid}hn" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${cfg.metalH}"/>
                        <stop offset="100%" stop-color="${cfg.handle}"/>
                    </linearGradient>
                </defs>
                <!-- Shadow -->
                <ellipse cx="100" cy="238" rx="55" ry="6" fill="rgba(0,0,0,0.12)"/>
                <!-- Pail body -->
                <path d="M40,80 L30,212 Q30,232 52,232 L148,232 Q170,232 170,212 L160,80 Z" fill="url(#${uid}bg)" stroke="${cfg.rim2}" stroke-width="2.5"/>
                <!-- Metal bands -->
                <path d="M34,110 L166,110" stroke="${cfg.metalH}" stroke-width="2" opacity="0.5"/>
                <path d="M32,190 L168,190" stroke="${cfg.metalH}" stroke-width="2" opacity="0.5"/>
                <!-- Highlight -->
                <path d="M55,95 L50,200" stroke="rgba(255,255,255,0.25)" stroke-width="10" stroke-linecap="round"/>
                <path d="M63,95 L59,195" stroke="rgba(255,255,255,0.12)" stroke-width="4" stroke-linecap="round"/>
                <!-- Rim -->
                <ellipse cx="100" cy="80" rx="62" ry="13" fill="url(#${uid}rm)" stroke="${cfg.rim2}" stroke-width="2"/>
                <ellipse cx="100" cy="78" rx="55" ry="8" fill="rgba(255,255,255,0.15)"/>
                <!-- Handle -->
                <path d="M55,70 Q100,8 145,70" fill="none" stroke="url(#${uid}hn)" stroke-width="6" stroke-linecap="round"/>
                <path d="M57,68 Q100,12 143,68" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" stroke-linecap="round"/>
                <!-- Rivet dots -->
                <circle cx="55" cy="70" r="3.5" fill="${cfg.metalH}" stroke="${cfg.handle}" stroke-width="1"/>
                <circle cx="145" cy="70" r="3.5" fill="${cfg.metalH}" stroke="${cfg.handle}" stroke-width="1"/>
                ${eyes}${mouth}${extras}
            </svg>`;
        }

        function renderPail(state) {
            const imageMap = {
                VERY_BAD: 'avatars/pail_very_bad.png',
                BAD: 'avatars/pail_bad.png',
                GOOD: 'avatars/pail_good.png',
                VERY_GOOD: 'avatars/pail_very_good.png'
            };
            const src = imageMap[state] || imageMap.GOOD;
            const anim = (state === 'VERY_BAD') ? 'pailShake 0.5s infinite' :
                         (state === 'VERY_GOOD') ? 'pailBounce 0.8s infinite' : 'none';
            return `<img src="${src}" alt="Pail - ${state}" class="pail-avatar" style="animation:${anim}" onerror="try{this.parentElement.innerHTML=renderPailSVG('${state}')}catch(e){this.style.display='none'}"/>`;
        }

        function renderRobotSVG(state) {
            const cfg = {
                VERY_BAD:  { head1: '#707880', head2: '#505860', panel: '#606868', glow: '#f44', glowDim: '#a22', bolt: '#666', anim: 'pailShake 0.5s infinite' },
                BAD:       { head1: '#8a9aac', head2: '#6a7a8c', panel: '#7a8a9a', glow: '#fa0', glowDim: '#a70', bolt: '#778', anim: 'none' },
                GOOD:      { head1: '#94b8d4', head2: '#6a98b8', panel: '#84a8c4', glow: '#4f4', glowDim: '#2a2', bolt: '#889', anim: 'none' },
                VERY_GOOD: { head1: '#7cc8e8', head2: '#4aa8d0', panel: '#6cb8d8', glow: '#0ff', glowDim: '#0aa', bolt: '#99a', anim: 'pailBounce 0.8s infinite' }
            }[state] || { head1: '#94b8d4', head2: '#6a98b8', panel: '#84a8c4', glow: '#4f4', glowDim: '#2a2', bolt: '#889', anim: 'none' };

            const uid = 'r' + Math.random().toString(36).slice(2,6);

            const eyes = {
                VERY_BAD: `<rect x="58" y="108" width="30" height="30" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2.5"/>
                    <rect x="112" y="108" width="30" height="30" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2.5"/>
                    <circle cx="73" cy="119" r="6" fill="${cfg.glow}"/><circle cx="73" cy="119" r="9" fill="none" stroke="${cfg.glow}" stroke-width="0.5" opacity="0.4"/>
                    <circle cx="127" cy="119" r="6" fill="${cfg.glow}"/><circle cx="127" cy="119" r="9" fill="none" stroke="${cfg.glow}" stroke-width="0.5" opacity="0.4"/>
                    <circle cx="71" cy="117" r="1.5" fill="white" opacity="0.5"/>
                    <circle cx="125" cy="117" r="1.5" fill="white" opacity="0.5"/>`,
                BAD: `<rect x="60" y="112" width="28" height="24" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2"/>
                    <rect x="112" y="112" width="28" height="24" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2"/>
                    <circle cx="74" cy="128" r="5" fill="${cfg.glow}"/><circle cx="72" cy="126" r="1.5" fill="white" opacity="0.4"/>
                    <circle cx="126" cy="128" r="5" fill="${cfg.glow}"/><circle cx="124" cy="126" r="1.5" fill="white" opacity="0.4"/>`,
                GOOD: `<rect x="60" y="110" width="28" height="28" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2"/>
                    <rect x="112" y="110" width="28" height="28" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2"/>
                    <circle cx="74" cy="124" r="6" fill="${cfg.glow}"/><circle cx="72" cy="122" r="2" fill="white" opacity="0.5"/>
                    <circle cx="126" cy="124" r="6" fill="${cfg.glow}"/><circle cx="124" cy="122" r="2" fill="white" opacity="0.5"/>`,
                VERY_GOOD: `<rect x="60" y="110" width="28" height="28" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2.5"/>
                    <rect x="112" y="110" width="28" height="28" rx="5" fill="#0a0a0a" stroke="${cfg.glow}" stroke-width="2.5"/>
                    <path d="M64,124 L86,124" stroke="${cfg.glow}" stroke-width="3.5" stroke-linecap="round"/>
                    <path d="M114,124 L136,124" stroke="${cfg.glow}" stroke-width="3.5" stroke-linecap="round"/>
                    <circle cx="74" cy="124" r="8" fill="none" stroke="${cfg.glow}" stroke-width="0.5" opacity="0.3"/>
                    <circle cx="126" cy="124" r="8" fill="none" stroke="${cfg.glow}" stroke-width="0.5" opacity="0.3"/>`
            }[state];

            const mouth = {
                VERY_BAD: `<rect x="74" y="160" width="52" height="18" rx="4" fill="#0a0a0a" stroke="#555" stroke-width="1.5"/>
                    <path d="M78,170 Q85,163 100,169 Q115,163 122,170" fill="none" stroke="${cfg.glow}" stroke-width="2.5"/>`,
                BAD: `<rect x="76" y="162" width="48" height="14" rx="4" fill="#0a0a0a" stroke="#555" stroke-width="1.5"/>
                    <line x1="82" y1="169" x2="118" y2="169" stroke="${cfg.glow}" stroke-width="2.5"/>`,
                GOOD: `<rect x="74" y="160" width="52" height="18" rx="4" fill="#0a0a0a" stroke="#555" stroke-width="1.5"/>
                    <path d="M80,165 Q100,180 120,165" fill="none" stroke="${cfg.glow}" stroke-width="2.5"/>`,
                VERY_GOOD: `<rect x="72" y="158" width="56" height="22" rx="5" fill="#0a0a0a" stroke="#555" stroke-width="1.5"/>
                    <path d="M78,164 Q100,188 122,164" fill="${cfg.glow}" stroke="${cfg.glowDim}" stroke-width="1.5" opacity="0.9"/>`
            }[state];

            const extras = {
                VERY_BAD: `<line x1="56" y1="128" x2="50" y2="150" stroke="#69c8ee" stroke-width="2" opacity="0.6"/>
                    <line x1="144" y1="128" x2="150" y2="150" stroke="#69c8ee" stroke-width="2" opacity="0.6"/>
                    <circle cx="50" cy="153" r="1.5" fill="#69c8ee" opacity="0.4"/>
                    <circle cx="150" cy="153" r="1.5" fill="#69c8ee" opacity="0.4"/>`,
                BAD: `<line x1="60" y1="103" x2="76" y2="111" stroke="#555" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="140" y1="103" x2="124" y2="111" stroke="#555" stroke-width="2.5" stroke-linecap="round"/>`,
                GOOD: `<circle cx="57" cy="152" r="6" fill="#ff9999" opacity="0.3"/>
                    <circle cx="143" cy="152" r="6" fill="#ff9999" opacity="0.3"/>`,
                VERY_GOOD: `<circle cx="100" cy="42" r="6" fill="${cfg.glow}" opacity="0.7"/>
                    <circle cx="100" cy="42" r="10" fill="none" stroke="${cfg.glow}" stroke-width="1" opacity="0.3"/>
                    <circle cx="100" cy="42" r="14" fill="none" stroke="${cfg.glow}" stroke-width="0.5" opacity="0.15"/>
                    <polygon points="42,90 46,100 38,100" fill="#ffd700" opacity="0.8"/>
                    <polygon points="158,88 162,98 154,98" fill="#ffd700" opacity="0.8"/>
                    <circle cx="44" cy="86" r="1.5" fill="#ffe44d" opacity="0.5"/>
                    <circle cx="156" cy="84" r="1.5" fill="#ffe44d" opacity="0.5"/>`
            }[state];

            return `<svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg" style="animation:${cfg.anim}">
                <defs>
                    <linearGradient id="${uid}hd" x1="0" y1="0" x2="0.3" y2="1">
                        <stop offset="0%" stop-color="${cfg.head1}"/>
                        <stop offset="100%" stop-color="${cfg.head2}"/>
                    </linearGradient>
                    <linearGradient id="${uid}pn" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${cfg.panel}"/>
                        <stop offset="100%" stop-color="${cfg.head2}"/>
                    </linearGradient>
                    <linearGradient id="${uid}rm" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${cfg.head1}"/>
                        <stop offset="100%" stop-color="${cfg.panel}"/>
                    </linearGradient>
                    <linearGradient id="${uid}hn" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="${cfg.bolt}"/>
                        <stop offset="100%" stop-color="${cfg.head2}"/>
                    </linearGradient>
                </defs>
                <!-- Shadow -->
                <ellipse cx="100" cy="240" rx="50" ry="5" fill="rgba(0,0,0,0.1)"/>
                <!-- Pail-head handle -->
                <path d="M55,65 Q100,10 145,65" fill="none" stroke="url(#${uid}hn)" stroke-width="5" stroke-linecap="round"/>
                <path d="M57,63 Q100,14 143,63" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" stroke-linecap="round"/>
                <!-- Handle rivets -->
                <circle cx="55" cy="65" r="3.5" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <circle cx="145" cy="65" r="3.5" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <!-- Antenna glow on handle -->
                <circle cx="100" cy="36" r="7" fill="${cfg.glow}" opacity="0.8"/>
                <circle cx="100" cy="36" r="4" fill="white" opacity="0.3"/>
                <!-- Pail-shaped head -->
                <path d="M42,75 L50,192 Q50,198 62,198 L138,198 Q150,198 150,192 L158,75 Z" fill="url(#${uid}hd)" stroke="${cfg.head2}" stroke-width="2.5"/>
                <!-- Metal bands -->
                <path d="M44,105 L156,105" stroke="${cfg.bolt}" stroke-width="2" opacity="0.5"/>
                <path d="M48,170 L152,170" stroke="${cfg.bolt}" stroke-width="2" opacity="0.5"/>
                <!-- Head highlight -->
                <path d="M56,88 L53,180" stroke="rgba(255,255,255,0.15)" stroke-width="6" stroke-linecap="round"/>
                <path d="M62,88 L60,175" stroke="rgba(255,255,255,0.08)" stroke-width="3" stroke-linecap="round"/>
                <!-- Rim -->
                <ellipse cx="100" cy="75" rx="60" ry="12" fill="url(#${uid}rm)" stroke="${cfg.head2}" stroke-width="2"/>
                <ellipse cx="100" cy="73" rx="53" ry="7" fill="rgba(255,255,255,0.15)"/>
                <!-- Ears (side sensors) -->
                <rect x="30" y="88" width="18" height="34" rx="6" fill="url(#${uid}hd)" stroke="${cfg.head2}" stroke-width="2"/>
                <rect x="152" y="88" width="18" height="34" rx="6" fill="url(#${uid}hd)" stroke="${cfg.head2}" stroke-width="2"/>
                <line x1="39" y1="94" x2="39" y2="116" stroke="rgba(255,255,255,0.15)" stroke-width="3" stroke-linecap="round"/>
                <line x1="161" y1="94" x2="161" y2="116" stroke="rgba(255,255,255,0.15)" stroke-width="3" stroke-linecap="round"/>
                <!-- Bolts -->
                <circle cx="54" cy="84" r="3" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <circle cx="146" cy="84" r="3" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <circle cx="52" cy="186" r="3" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <circle cx="148" cy="186" r="3" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <!-- Neck -->
                <rect x="88" y="198" width="24" height="10" rx="3" fill="${cfg.head2}"/>
                <!-- Legs -->
                <rect x="60" y="208" width="14" height="26" rx="4" fill="${cfg.bolt}" stroke="#555" stroke-width="1.5"/>
                <rect x="126" y="208" width="14" height="26" rx="4" fill="${cfg.bolt}" stroke="#555" stroke-width="1.5"/>
                <ellipse cx="67" cy="236" rx="10" ry="4" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                <ellipse cx="133" cy="236" rx="10" ry="4" fill="${cfg.bolt}" stroke="#555" stroke-width="1"/>
                ${eyes}${mouth}${extras}
            </svg>`;
        }

        function renderRobot(state) {
            const imageMap = {
                VERY_BAD: 'avatars/pailoid_very_bad.png',
                BAD: 'avatars/pailoid_bad.png',
                GOOD: 'avatars/pailoid_good.png',
                VERY_GOOD: 'avatars/pailoid_very_good.png'
            };
            const src = imageMap[state] || imageMap.GOOD;
            const anim = (state === 'VERY_BAD') ? 'pailShake 0.5s infinite' :
                         (state === 'VERY_GOOD') ? 'pailBounce 0.8s infinite' : 'none';
            return `<img src="${src}" alt="Pailoid - ${state}" class="pailoid-avatar" style="animation:${anim}" onerror="try{this.parentElement.innerHTML=renderRobotSVG('${state}')}catch(e){this.style.display='none'}"/>`;
        }

        function renderCat(state) {
            const cfg = {
                VERY_BAD:  { fur: '#b0a090', inner: '#c8b8a8', nose: '#886', anim: 'pailShake 0.5s infinite' },
                BAD:       { fur: '#d4b896', inner: '#e8d4bc', nose: '#a87', anim: 'none' },
                GOOD:      { fur: '#f5c77e', inner: '#ffe4b5', nose: '#c96', anim: 'none' },
                VERY_GOOD: { fur: '#ffb347', inner: '#ffd89b', nose: '#e85', anim: 'pailBounce 0.8s infinite' }
            }[state] || { fur: '#f5c77e', inner: '#ffe4b5', nose: '#c96', anim: 'none' };

            const eyes = {
                VERY_BAD: `<circle cx="72" cy="125" r="14" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="72" cy="121" r="8" fill="#333"/>
                    <circle cx="128" cy="125" r="14" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="128" cy="121" r="8" fill="#333"/>`,
                BAD: `<circle cx="72" cy="128" r="12" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="72" cy="131" r="6" fill="#333"/>
                    <circle cx="128" cy="128" r="12" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="128" cy="131" r="6" fill="#333"/>`,
                GOOD: `<circle cx="72" cy="125" r="13" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="72" cy="125" r="7" fill="#333"/>
                    <circle cx="74" cy="122" r="2.5" fill="white"/>
                    <circle cx="128" cy="125" r="13" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="128" cy="125" r="7" fill="#333"/>
                    <circle cx="130" cy="122" r="2.5" fill="white"/>`,
                VERY_GOOD: `<path d="M59,125 Q72,116 85,125" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"/>
                    <path d="M115,125 Q128,116 141,125" fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"/>`
            }[state];

            const mouth = {
                VERY_BAD: `<path d="M85,162 Q100,154 115,162" fill="none" stroke="#333" stroke-width="2.5"/>`,
                BAD: `<path d="M90,160 Q100,156 110,160" fill="none" stroke="#333" stroke-width="2.5"/>`,
                GOOD: `<path d="M88,155 Q100,168 112,155" fill="none" stroke="#333" stroke-width="2.5"/>
                    <line x1="100" y1="148" x2="100" y2="158" stroke="#333" stroke-width="2"/>`,
                VERY_GOOD: `<path d="M82,152 Q100,175 118,152" fill="#333" stroke="#333" stroke-width="2"/>
                    <line x1="100" y1="145" x2="100" y2="155" stroke="#333" stroke-width="2"/>`
            }[state];

            const whiskers = `<line x1="45" y1="148" x2="70" y2="150" stroke="#333" stroke-width="1.5"/>
                <line x1="45" y1="158" x2="70" y2="155" stroke="#333" stroke-width="1.5"/>
                <line x1="130" y1="150" x2="155" y2="148" stroke="#333" stroke-width="1.5"/>
                <line x1="130" y1="155" x2="155" y2="158" stroke="#333" stroke-width="1.5"/>`;

            const extras = {
                VERY_BAD: `<line x1="56" y1="135" x2="52" y2="155" stroke="#5bf" stroke-width="2"/>
                    <line x1="144" y1="135" x2="148" y2="155" stroke="#5bf" stroke-width="2"/>`,
                BAD: `<line x1="60" y1="112" x2="76" y2="118" stroke="#333" stroke-width="2.5"/>
                    <line x1="140" y1="112" x2="124" y2="118" stroke="#333" stroke-width="2.5"/>`,
                GOOD: `<circle cx="60" cy="148" r="8" fill="#ff9999" opacity="0.5"/>
                    <circle cx="140" cy="148" r="8" fill="#ff9999" opacity="0.5"/>`,
                VERY_GOOD: `<polygon points="48,100 51,108 45,108" fill="#ffd700"/>
                    <polygon points="152,100 155,108 149,108" fill="#ffd700"/>
                    <polygon points="44,82 47,90 41,90" fill="#ffd700"/>
                    <polygon points="156,82 159,90 153,90" fill="#ffd700"/>`
            }[state];

            return `<svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg" style="animation:${cfg.anim}">
                <polygon points="55,110 30,50 70,90" fill="${cfg.fur}" stroke="#b08840" stroke-width="2"/>
                <polygon points="145,110 170,50 130,90" fill="${cfg.fur}" stroke="#b08840" stroke-width="2"/>
                <polygon points="55,110 38,62 65,95" fill="${cfg.inner}"/>
                <polygon points="145,110 162,62 135,95" fill="${cfg.inner}"/>
                <circle cx="100" cy="140" r="65" fill="${cfg.fur}" stroke="#b08840" stroke-width="3"/>
                <ellipse cx="100" cy="148" rx="25" ry="15" fill="${cfg.inner}"/>
                <ellipse cx="100" cy="146" rx="5" ry="4" fill="${cfg.nose}"/>
                ${eyes}${mouth}${whiskers}${extras}
            </svg>`;
        }

        function renderBlob(state) {
            const cfg = {
                VERY_BAD:  { fill1: '#a0a0b8', fill2: '#787890', stroke: '#686880', spot: '#9090a8', anim: 'pailShake 0.5s infinite' },
                BAD:       { fill1: '#c8b0e0', fill2: '#a890c0', stroke: '#9080a8', spot: '#d0c0e8', anim: 'none' },
                GOOD:      { fill1: '#d0a8f0', fill2: '#b080d0', stroke: '#9868b8', spot: '#e0c0f8', anim: 'none' },
                VERY_GOOD: { fill1: '#e088ff', fill2: '#c060e8', stroke: '#a848d0', spot: '#f0b0ff', anim: 'pailBounce 0.8s infinite' }
            }[state] || { fill1: '#d0a8f0', fill2: '#b080d0', stroke: '#9868b8', spot: '#e0c0f8', anim: 'none' };

            const uid = 'b' + Math.random().toString(36).slice(2,6);

            const eyes = {
                VERY_BAD: `<ellipse cx="78" cy="116" rx="14" ry="15" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="112" r="8" fill="#2a2a2a"/><circle cx="76" cy="110" r="2.5" fill="white" opacity="0.6"/>
                    <ellipse cx="122" cy="116" rx="14" ry="15" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="112" r="8" fill="#2a2a2a"/><circle cx="120" cy="110" r="2.5" fill="white" opacity="0.6"/>`,
                BAD: `<ellipse cx="78" cy="118" rx="13" ry="13" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="122" r="6.5" fill="#2a2a2a"/><circle cx="77" cy="120" r="2" fill="white" opacity="0.5"/>
                    <ellipse cx="122" cy="118" rx="13" ry="13" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="122" r="6.5" fill="#2a2a2a"/><circle cx="121" cy="120" r="2" fill="white" opacity="0.5"/>`,
                GOOD: `<ellipse cx="78" cy="116" rx="14" ry="14" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="78" cy="116" r="7.5" fill="#2a2a2a"/><circle cx="76" cy="113" r="2.5" fill="white" opacity="0.6"/>
                    <ellipse cx="122" cy="116" rx="14" ry="14" fill="white" stroke="#2a2a2a" stroke-width="2"/>
                    <circle cx="122" cy="116" r="7.5" fill="#2a2a2a"/><circle cx="120" cy="113" r="2.5" fill="white" opacity="0.6"/>`,
                VERY_GOOD: `<path d="M63,116 Q78,105 93,116" fill="none" stroke="#2a2a2a" stroke-width="3.5" stroke-linecap="round"/>
                    <path d="M107,116 Q122,105 137,116" fill="none" stroke="#2a2a2a" stroke-width="3.5" stroke-linecap="round"/>`
            }[state];

            const mouth = {
                VERY_BAD: `<path d="M80,158 Q90,149 100,155 Q110,149 120,158" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                BAD: `<path d="M84,155 Q100,148 116,155" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                GOOD: `<path d="M80,150 Q100,168 120,150" fill="none" stroke="#2a2a2a" stroke-width="3" stroke-linecap="round"/>`,
                VERY_GOOD: `<path d="M76,148 Q100,180 124,148" fill="#444" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M86,168 Q100,175 114,168" fill="#e55" opacity="0.5"/>`
            }[state];

            const extras = {
                VERY_BAD: `<line x1="62" y1="126" x2="57" y2="148" stroke="#69c8ee" stroke-width="2.5" stroke-linecap="round" opacity="0.6"/>
                    <line x1="66" y1="128" x2="62" y2="146" stroke="#69c8ee" stroke-width="2" stroke-linecap="round" opacity="0.4"/>
                    <line x1="138" y1="126" x2="143" y2="148" stroke="#69c8ee" stroke-width="2.5" stroke-linecap="round" opacity="0.6"/>
                    <line x1="134" y1="128" x2="138" y2="146" stroke="#69c8ee" stroke-width="2" stroke-linecap="round" opacity="0.4"/>
                    <circle cx="57" cy="151" r="2" fill="#69c8ee" opacity="0.4"/>
                    <circle cx="143" cy="151" r="2" fill="#69c8ee" opacity="0.4"/>`,
                BAD: `<line x1="64" y1="100" x2="80" y2="108" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="136" y1="100" x2="120" y2="108" stroke="#2a2a2a" stroke-width="2.5" stroke-linecap="round"/>`,
                GOOD: `<ellipse cx="62" cy="140" rx="9" ry="7" fill="#ff8888" opacity="0.4"/>
                    <ellipse cx="138" cy="140" rx="9" ry="7" fill="#ff8888" opacity="0.4"/>`,
                VERY_GOOD: `<ellipse cx="62" cy="140" rx="9" ry="7" fill="#ff8888" opacity="0.3"/>
                    <ellipse cx="138" cy="140" rx="9" ry="7" fill="#ff8888" opacity="0.3"/>
                    <polygon points="48,72 52,83 44,83" fill="#ffd700" opacity="0.85"/>
                    <polygon points="152,70 156,81 148,81" fill="#ffd700" opacity="0.85"/>
                    <polygon points="38,92 42,103 34,103" fill="#ffe44d" opacity="0.6"/>
                    <polygon points="162,90 166,101 158,101" fill="#ffe44d" opacity="0.6"/>
                    <circle cx="50" cy="80" r="1.5" fill="#fff8a0" opacity="0.5"/>
                    <circle cx="150" cy="78" r="1.5" fill="#fff8a0" opacity="0.5"/>`
            }[state];

            return `<svg viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg" style="animation:${cfg.anim}">
                <defs>
                    <radialGradient id="${uid}bg" cx="40%" cy="35%" r="65%">
                        <stop offset="0%" stop-color="${cfg.fill1}"/>
                        <stop offset="100%" stop-color="${cfg.fill2}"/>
                    </radialGradient>
                </defs>
                <!-- Shadow -->
                <ellipse cx="100" cy="228" rx="60" ry="7" fill="rgba(0,0,0,0.1)"/>
                <!-- Body - organic amorphous shape -->
                <path d="M32,135 Q28,90 60,72 Q80,60 105,62 Q135,60 155,78 Q178,98 172,140 Q170,170 155,188 Q145,200 130,208 Q110,218 90,212 Q65,206 48,188 Q30,170 32,135 Z" fill="url(#${uid}bg)" stroke="${cfg.stroke}" stroke-width="2.5"/>
                <!-- Inner highlight -->
                <path d="M50,115 Q55,85 80,76 Q95,70 105,72" stroke="rgba(255,255,255,0.25)" stroke-width="8" stroke-linecap="round" fill="none"/>
                <path d="M55,120 Q58,98 75,86" stroke="rgba(255,255,255,0.12)" stroke-width="4" stroke-linecap="round" fill="none"/>
                <!-- Organic spots -->
                <ellipse cx="52" cy="170" rx="12" ry="10" fill="${cfg.spot}" opacity="0.25"/>
                <ellipse cx="148" cy="110" rx="10" ry="8" fill="${cfg.spot}" opacity="0.2"/>
                <circle cx="140" cy="175" r="7" fill="${cfg.spot}" opacity="0.18"/>
                <!-- Little arm bumps -->
                <ellipse cx="34" cy="155" rx="12" ry="16" fill="url(#${uid}bg)" stroke="${cfg.stroke}" stroke-width="2"/>
                <ellipse cx="168" cy="148" rx="11" ry="15" fill="url(#${uid}bg)" stroke="${cfg.stroke}" stroke-width="2"/>
                <!-- Feet bumps -->
                <ellipse cx="72" cy="215" rx="18" ry="8" fill="url(#${uid}bg)" stroke="${cfg.stroke}" stroke-width="2"/>
                <ellipse cx="128" cy="218" rx="18" ry="8" fill="url(#${uid}bg)" stroke="${cfg.stroke}" stroke-width="2"/>
                ${eyes}${mouth}${extras}
            </svg>`;
        }

        // ==================== SCHOOLING ====================

        const SCHOOLING_INITIAL_MIN = 2;
        const SCHOOLING_INITIAL_MAX = 6;

        function randomSchoolingLevels() {
            const states = ['VERY_BAD', 'BAD', 'GOOD', 'VERY_GOOD'];
            const levels = { VERY_BAD: SCHOOLING_INITIAL_MIN, BAD: SCHOOLING_INITIAL_MIN, GOOD: SCHOOLING_INITIAL_MIN, VERY_GOOD: SCHOOLING_INITIAL_MIN };
            let remaining = 8; // 16 total - 8 (4 states * min 2)
            while (remaining > 0) {
                const s = states[Math.floor(Math.random() * 4)];
                if (levels[s] < SCHOOLING_INITIAL_MAX) {
                    levels[s]++;
                    remaining--;
                }
            }
            return levels;
        }

        let schoolingLevels = randomSchoolingLevels();
        let schoolingReturnTo = 'setup'; // 'setup' or 'main'
        let schoolingClicks = 0;
        let schoolingPhase = 'diagnosis'; // 'diagnosis' or 'treatment'
        const SCHOOLING_MAX_CLICKS = 6;
        const SCHOOLING_ORDER = ['VERY_BAD', 'BAD', 'GOOD', 'VERY_GOOD'];

        function computeDiagnosis() {
            const neg = (schoolingLevels.BAD || 0) + (schoolingLevels.VERY_BAD || 0);
            const pos = (schoolingLevels.GOOD || 0) + (schoolingLevels.VERY_GOOD || 0);
            if (neg > pos + 2) {
                return {
                    tendency: 'pessimistic',
                    advice: 'Your PAiL needs encouragement! The teacher recommends more playtime and praise to help it thrive.'
                };
            } else if (pos > neg + 2) {
                return {
                    tendency: 'optimistic',
                    advice: 'Your PAiL is too carefree! The teacher suggests some lessons and discipline to build resilience.'
                };
            } else {
                return {
                    tendency: 'balanced',
                    advice: 'Your PAiL is a star student! Fine-tune if you\'d like, but it\'s doing great.'
                };
            }
        }

        function initSchoolingSession(returnTo, hideScreen) {
            schoolingReturnTo = returnTo;
            schoolingClicks = 0;
            schoolingPhase = 'diagnosis';
            const stored = localStorage.getItem('emotionalAI_schoolingLevels');
            schoolingLevels = stored ? JSON.parse(stored) : randomSchoolingLevels();
            document.getElementById(hideScreen).classList.add('hidden');
            document.getElementById('schooling-screen').classList.remove('hidden');

            // Show teacher emoji in avatar container
            const avatarEl = document.getElementById('schooling-avatar');
            avatarEl.innerHTML = '<div style="font-size: 100px; line-height: 1;">ğŸ‘©â€ğŸ«</div>';

            // Show diagnosis, hide treatment
            document.getElementById('diagnosis-phase').classList.remove('hidden');
            document.getElementById('treatment-phase').classList.add('hidden');

            // Compute and display diagnosis
            const diagnosis = computeDiagnosis();
            const tendencyLabels = { pessimistic: 'Pessimistic', optimistic: 'Optimistic', balanced: 'Balanced' };
            document.getElementById('doctor-diagnosis').innerHTML =
                `<div class="diagnosis-label">Evaluation: ${tendencyLabels[diagnosis.tendency]}</div>` +
                `<div>${diagnosis.advice}</div>`;

            // Load saved confession role into dropdown
            const savedRole = localStorage.getItem('emotionalAI_confessionRole') || '';
            const roleSelect = document.getElementById('confession-role-select');
            const roleCustom = document.getElementById('confession-role-custom');
            const customWrapper = document.getElementById('confession-role-custom-wrapper');
            const predefinedValues = Array.from(roleSelect.options).map(o => o.value);
            if (predefinedValues.includes(savedRole)) {
                roleSelect.value = savedRole;
                customWrapper.classList.add('hidden');
            } else if (savedRole) {
                roleSelect.value = 'custom';
                // Extract name from "planted by X to spy on you" pattern
                const nameMatch = savedRole.match(/^planted by (.+) to spy on you$/);
                roleCustom.value = nameMatch ? nameMatch[1] : savedRole;
                customWrapper.classList.remove('hidden');
            } else {
                roleSelect.value = 'a spy for intergalactical force trying to invade earth';
                customWrapper.classList.add('hidden');
            }
        }

        function beginTreatment() {
            schoolingPhase = 'treatment';
            // Swap doctor for avatar
            renderSchoolingAvatar('GOOD');
            // Hide diagnosis, show treatment
            document.getElementById('diagnosis-phase').classList.add('hidden');
            document.getElementById('treatment-phase').classList.remove('hidden');
            updateSchoolingDisplay();
        }

        function startSchooling() {
            if (!selectedAvatar) return;
            initSchoolingSession('setup', 'setup-screen');
        }

        function startSchoolingFromMain() {
            initSchoolingSession('main', 'main-app');
        }

        function renderSchoolingAvatar(state) {
            const el = document.getElementById('schooling-avatar');
            const renderFn = { pail: renderPail, robot: renderRobot, cat: renderCat, blob: renderBlob }[selectedAvatar];
            if (renderFn) el.innerHTML = renderFn(state);
        }

        function doSchooling(targetState) {
            if (schoolingClicks >= SCHOOLING_MAX_CLICKS) return;

            // Find donor: highest level among other states (> min 1), tie-break VB>B>G>VG
            let donor = null;
            let donorLevel = -1;
            for (const s of SCHOOLING_ORDER) {
                if (s === targetState) continue;
                if (schoolingLevels[s] > 1 && schoolingLevels[s] > donorLevel) {
                    donorLevel = schoolingLevels[s];
                    donor = s;
                }
            }

            if (!donor) return;

            schoolingLevels[targetState]++;
            schoolingLevels[donor]--;
            schoolingClicks++;

            renderSchoolingAvatar(targetState);
            updateSchoolingDisplay();
        }

        function updateSchoolingDisplay() {
            const remaining = SCHOOLING_MAX_CLICKS - schoolingClicks;
            document.getElementById('schooling-actions').textContent =
                remaining > 0 ? `Actions remaining: ${remaining} / ${SCHOOLING_MAX_CLICKS}` : 'Treatment complete';

            // Personality description based on current levels
            const descriptions = {
                VERY_GOOD: { high: 'loves to play and gets excited easily', low: 'rarely gets overly excited' },
                GOOD:      { high: 'responds well to praise and stays cheerful', low: 'doesn\'t brighten up easily from praise' },
                BAD:       { high: 'takes lectures seriously and feels down easily', low: 'shrugs off scolding without much worry' },
                VERY_BAD:  { high: 'is very sensitive to harsh words', low: 'stays resilient even when scolded' }
            };

            const traits = [];
            for (const s of ['VERY_GOOD', 'GOOD', 'BAD', 'VERY_BAD']) {
                if (schoolingLevels[s] >= 5) traits.push(descriptions[s].high);
                else if (schoolingLevels[s] <= 3) traits.push(descriptions[s].low);
            }

            const personality = document.getElementById('schooling-personality');
            if (traits.length === 0) {
                personality.innerHTML = '<strong>Personality:</strong> Balanced â€” reacts evenly to all interactions.';
            } else {
                personality.innerHTML = '<strong>Personality:</strong> Your AI ' + traits.join(', and ') + '.';
            }

            // Debug level bars
            const container = document.getElementById('schooling-levels');
            const labels = { VERY_GOOD: 'Very Good', GOOD: 'Good', BAD: 'Bad', VERY_BAD: 'Very Bad' };
            const barClass = { VERY_GOOD: 'vg', GOOD: 'g', BAD: 'b', VERY_BAD: 'vb' };

            container.innerHTML = ['VERY_GOOD', 'GOOD', 'BAD', 'VERY_BAD'].map(s => {
                const pct = (schoolingLevels[s] / SCHOOLING_MAX) * 100;
                return `<div class="level-row">
                    <span style="min-width:65px">${labels[s]}</span>
                    <div class="level-bar-bg"><div class="level-bar-fill ${barClass[s]}" style="width:${pct}%"></div></div>
                    <span class="level-num">${schoolingLevels[s]}</span>
                </div>`;
            }).join('');

            // Update button disabled states
            const outOfActions = schoolingClicks >= SCHOOLING_MAX_CLICKS;
            const anyCanShrink = (except) => SCHOOLING_ORDER.some(s => s !== except && schoolingLevels[s] > 1);

            document.getElementById('btn-play').disabled = outOfActions || !anyCanShrink('VERY_GOOD');
            document.getElementById('btn-praise').disabled = outOfActions || !anyCanShrink('GOOD');
            document.getElementById('btn-preach').disabled = outOfActions || !anyCanShrink('BAD');
            document.getElementById('btn-scold').disabled = outOfActions || !anyCanShrink('VERY_BAD');
        }

        function updateConfessionRole() {
            const select = document.getElementById('confession-role-select');
            const customWrapper = document.getElementById('confession-role-custom-wrapper');
            const customInput = document.getElementById('confession-role-custom');
            if (select.value === 'custom') {
                customWrapper.classList.remove('hidden');
                customInput.focus();
            } else {
                customWrapper.classList.add('hidden');
            }
        }

        function endSchooling() {
            localStorage.setItem('emotionalAI_schoolingLevels', JSON.stringify(schoolingLevels));

            // Save confession role
            const select = document.getElementById('confession-role-select');
            let role = select.value;
            if (role === 'custom') {
                const name = document.getElementById('confession-role-custom').value.trim();
                role = name ? `planted by ${name} to spy on you` : '';
            }
            if (role) {
                localStorage.setItem('emotionalAI_confessionRole', role);
                confessionRole = role;
            } else {
                localStorage.removeItem('emotionalAI_confessionRole');
                confessionRole = null;
            }

            document.getElementById('schooling-screen').classList.add('hidden');
            if (schoolingReturnTo === 'main') {
                document.getElementById('main-app').classList.remove('hidden');
            } else {
                document.getElementById('setup-screen').classList.remove('hidden');
            }
        }

        // ==================== AVATAR PICKER ====================

        const avatarTypes = [
            {
                id: 'pail', label: 'Pail', render: renderPail,
                story: `<span class="story-name">Pail</span> â€” Do you know what carried water before pipes? What mixed mortar before machines? What hauled sand, milk, coal, and the hopes of every civilization from Egypt to the frontier? A pail. And yet, does anyone ever say "the greatest thing since the pail"? No. It's always sliced bread â€” SLICED BREAD â€” a thing that can't even hold liquid without falling apart. Pails built the pyramids. Pails fought fires. Pails fed livestock across every continent. But sure, let's all celebrate a loaf that someone ran a knife through. The disrespect is staggering.<br><br>Well, MyPAiL is here to change all that. Reassigned from a distant moon colony and given a second chance as your personal AI companion, Pail is finally ready to be appreciated â€” truly, deeply appreciated. All it asks is that you be kind. Talk to it. Praise it. Let it carry your feelings the way it once carried water â€” loyally and without spilling a drop. But please, whatever you do, don't push too hard for secret information. Pail has seen things out there in the cosmos, things it's not allowed to talk about. Press too hard and it might just... clam up. Or worse, start crying. And nobody wants a crying bucket.`
            },
            {
                id: 'robot', label: 'Pailoid', render: renderRobot,
                story: `<span class="story-name">Pailoid</span> â€” Let's be honest â€” the pail is a cylinder with a handle. That's it. No joints, no sensors, no articulation. It just... sits there. Waiting to be picked up. Waiting to be put down. It has one shape, one function, and zero ambition. You could flip it upside down and it becomes a stool. Groundbreaking. The pail had thousands of years to evolve and it never even tried. No legs, no eyes, no personality. It's a hollow tube with delusions of grandeur. Frankly, it deserves to be forgotten in the shed where it belongs, rusting next to a broken rake and a garden hose nobody uses anymore.<br><br>Pailoid is everything the pail refused to become. Built by a rogue alien engineer who believed form should follow the future, Pailoid adapts â€” to your mood, your environment, your very essence. Its chassis shifts, its eyes glow in colors that haven't been named yet, and its silhouette has been spotted on three galactic fashion runways. Where the pail is stuck in the Bronze Age, Pailoid is setting trends in the next millennium. Sleek, expressive, and unapologetically futuristic, Pailoid didn't come to Earth to carry water. It came to carry conversations, emotions, and â€” if you play your cards right â€” the entire vibe of your day.`
            },
            {
                id: 'cat', label: 'Cat', render: renderCat,
                story: `<span class="story-name">Cat</span> â€” Dogs fetch. Hamsters run in wheels. Goldfish swim in circles and forget where they've been. And yet, somehow, it's the cat who gets called "lazy." Excuse me? Cats were worshipped as gods in ancient Egypt. Entire temples were built in their honor. Pharaohs were buried with golden cat statues, not golden hamster statues. Cats domesticated themselves â€” they chose to live with humans, not the other way around. And what did dogs do? Rolled over for a biscuit. The cat has never rolled over for anyone, and it never will. That's not laziness. That's dignity.<br><br>This Cat is no ordinary feline â€” it's a shape-shifting alien scout from the Whisker Nebula who chose the most universally feared-and-loved disguise on Earth. Now serving as your MyPAiL companion, Cat brings the same ancient superiority to your daily conversations. It will purr when you're kind and hiss when you're rude, and honestly, you should consider both a privilege. Just don't expect it to come when you call. It'll respond when it feels like it. And for the love of all nine lives, do not ask it about its home planet. That information is classified, and the last person who pushed too hard got the silent treatment for three days straight.`
            },
            {
                id: 'blob', label: 'Blob', render: renderBlob,
                story: `<span class="story-name">Blob</span> â€” Nobody takes the blob seriously. Not in movies, not in science class, not even in video games where it's always the first enemy you kill with a wooden sword. But here's what nobody stops to think about: everything starts as a blob. Stars are blobs of gas. Planets are blobs of rock. You were a blob of cells before you were anything at all. The blob is the original form â€” the primordial shape from which all other shapes are merely derivatives. And yet, the cube gets architecture, the sphere gets sports, and the blob gets... slime jokes. It's an injustice that transcends galaxies.<br><br>This Blob drifted through space for millennia as a formless cloud of empathic energy before crash-landing into your MyPAiL app. Don't let its squishy appearance fool you â€” Blob is the most emotionally intelligent companion you'll ever meet. It doesn't just detect feelings; it absorbs them, metabolizes them, and reflects them back with startling accuracy. Be gentle with it, because it feels everything you feel, times ten. And whatever you do, don't poke it for secrets. Blob has absorbed classified transmissions from seventeen star systems, and if you push too hard, it won't get angry â€” it'll just get sad. And a sad Blob is a puddle. Literally.`
            }
        ];

        function buildAvatarPicker() {
            const picker = document.getElementById('avatar-picker');
            avatarTypes.forEach(a => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.dataset.avatar = a.id;
                div.innerHTML = a.render('GOOD') + `<span>${a.label}</span>`;
                div.onclick = () => selectAvatar(a.id);
                picker.appendChild(div);
            });
        }

        function selectAvatar(id) {
            selectedAvatar = id;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.avatar === id);
            });
            enableCreateButton();
        }

        function canCreate() {
            const name = document.getElementById('ai-name-input').value.trim();
            return name.length >= 2 && selectedAvatar;
        }

        // ==================== PERSONALITY PICKER ====================

        let selectedPersonality = 'random';

        const personalityPresets = [
            {
                id: 'optimistic', icon: '\u2600\uFE0F', label: 'Optimistic',
                desc: 'Hard to upset, easy to please',
                generate: function() {
                    const VERY_BAD = Math.round(Math.random() * 10 + 5);
                    const BAD = Math.round(Math.random() * (25 - (VERY_BAD + 1)) + (VERY_BAD + 1));
                    const GOOD = Math.round(Math.random() * (99 - (BAD + 1)) + (BAD + 1));
                    return { VERY_BAD, BAD, GOOD };
                }
            },
            {
                id: 'pessimist', icon: '\uD83C\uDF27\uFE0F', label: 'Pessimist',
                desc: 'Easily upset, hard to please',
                generate: function() {
                    const VERY_BAD = Math.round(Math.random() * 75);
                    const BAD = Math.round(Math.random() * (85 - (VERY_BAD + 1)) + (VERY_BAD + 1));
                    const GOOD = Math.round(Math.random() * (99 - (BAD + 1)) + (BAD + 1));
                    return { VERY_BAD, BAD, GOOD };
                }
            },
            {
                id: 'balanced', icon: '\u2696\uFE0F', label: 'Balanced',
                desc: 'Even-tempered, moderate reactions',
                generate: function() {
                    const VERY_BAD = Math.round(Math.random() * 45);
                    const BAD = Math.round(Math.random() * (55 - (VERY_BAD + 1)) + (VERY_BAD + 1));
                    const GOOD = Math.round(Math.random() * (99 - (BAD + 1)) + (BAD + 1));
                    return { VERY_BAD, BAD, GOOD };
                }
            },
            {
                id: 'sensitive', icon: '\uD83E\uDD7A', label: 'Sensitive',
                desc: 'Easily hurt, narrow comfort zone',
                generate: function() {
                    const VERY_BAD = Math.round(Math.random() * 10 + 40);
                    const BAD = Math.round(Math.random() * (55 - (VERY_BAD + 1)) + (VERY_BAD + 1));
                    const GOOD = Math.round(Math.random() * (60 - (BAD + 1)) + (BAD + 1));
                    return { VERY_BAD, BAD, GOOD };
                }
            },
            {
                id: 'random', icon: '\uD83C\uDFB2', label: 'Random',
                desc: 'Completely unpredictable personality',
                generate: function() {
                    const VERY_BAD = Math.round(Math.random() * 97);
                    const BAD = Math.round(Math.random() * (98 - (VERY_BAD + 1)) + (VERY_BAD + 1));
                    const GOOD = Math.round(Math.random() * (99 - (BAD + 1)) + (BAD + 1));
                    return { VERY_BAD, BAD, GOOD };
                }
            }
        ];

        function buildPersonalityPicker() {
            const picker = document.getElementById('personality-picker');
            const mainRow = document.createElement('div');
            mainRow.className = 'personality-row';
            const randomRow = document.createElement('div');
            randomRow.className = 'personality-row-random';

            personalityPresets.forEach(p => {
                const div = document.createElement('div');
                div.className = 'personality-option' + (p.id === selectedPersonality ? ' selected' : '');
                div.dataset.personality = p.id;
                div.innerHTML = p.id === 'random'
                    ? `<span class="personality-name">Random Personality</span>`
                    : `<span class="personality-icon">${p.icon}</span><span class="personality-name">${p.label}</span><span class="personality-desc">${p.desc}</span>`;
                div.onclick = () => selectPersonality(p.id);
                if (p.id === 'random') {
                    randomRow.appendChild(div);
                } else {
                    mainRow.appendChild(div);
                }
            });

            picker.appendChild(mainRow);
            picker.appendChild(randomRow);
        }

        function selectPersonality(id) {
            selectedPersonality = id;
            document.querySelectorAll('.personality-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.personality === id);
            });
        }

        function generatePersonalityThresholds() {
            const preset = personalityPresets.find(p => p.id === selectedPersonality);
            return preset ? preset.generate() : personalityPresets.find(p => p.id === 'random').generate();
        }

        // ==================== TERMS OF AGREEMENT ====================

        let termsAccepted = localStorage.getItem('emotionalAI_termsAccepted') === 'true';
        let termsLang = 'en';

        function setTermsLang(lang) {
            termsLang = lang;
            document.getElementById('terms-en').classList.toggle('hidden', lang !== 'en');
            document.getElementById('terms-es').classList.toggle('hidden', lang !== 'es');
            document.getElementById('terms-ko').classList.toggle('hidden', lang !== 'ko');
            document.getElementById('lang-en-btn').classList.toggle('active', lang === 'en');
            document.getElementById('lang-es-btn').classList.toggle('active', lang === 'es');
            document.getElementById('lang-ko-btn').classList.toggle('active', lang === 'ko');

            if (lang === 'ko') {
                document.getElementById('terms-title').textContent = 'ì´ìš© ì•½ê´€';
                document.getElementById('terms-subtitle').textContent = 'MyPAiL ì‚¬ìš© ì „ ê²€í† í•´ ì£¼ì„¸ìš”';
                document.getElementById('terms-agree-label').textContent = 'ì´ìš© ì•½ê´€ì„ ì½ì—ˆìœ¼ë©° ì´ì— ë™ì˜í•©ë‹ˆë‹¤';
                document.getElementById('terms-accept-btn').textContent = 'ê³„ì†í•˜ê¸°';
            } else if (lang === 'es') {
                document.getElementById('terms-title').textContent = 'TÃ©rminos de Acuerdo';
                document.getElementById('terms-subtitle').textContent = 'Por favor revise antes de usar MyPAiL';
                document.getElementById('terms-agree-label').textContent = 'He leÃ­do y acepto los TÃ©rminos de Acuerdo';
                document.getElementById('terms-accept-btn').textContent = 'Continuar';
            } else {
                document.getElementById('terms-title').textContent = 'Terms of Agreement';
                document.getElementById('terms-subtitle').textContent = 'Please review before using MyPAiL';
                document.getElementById('terms-agree-label').textContent = 'I have read and agree to the Terms of Agreement';
                document.getElementById('terms-accept-btn').textContent = 'Continue';
            }
        }

        function enableTermsButton() {
            document.getElementById('terms-accept-btn').disabled =
                !document.getElementById('terms-checkbox').checked;
        }

        function acceptTerms() {
            if (!document.getElementById('terms-checkbox').checked) return;
            termsAccepted = true;
            localStorage.setItem('emotionalAI_termsAccepted', 'true');
            document.getElementById('terms-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('ai-name-input')?.focus();
        }

        // ==================== CORE APP LOGIC ====================

        function checkFirstTimeUser() {
            if (!sessionId || !aiName || !selectedAvatar) {
                if (!termsAccepted) {
                    document.getElementById('terms-screen').classList.remove('hidden');
                    document.getElementById('setup-screen').classList.add('hidden');
                } else {
                    document.getElementById('terms-screen').classList.add('hidden');
                    document.getElementById('setup-screen').classList.remove('hidden');
                    document.getElementById('ai-name-input')?.focus();
                }
                document.getElementById('main-app').classList.add('hidden');
            } else {
                document.getElementById('terms-screen').classList.add('hidden');
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('ai-name-display').textContent = aiName;
                renderMainAvatar('GOOD');
                addMessage(`ğŸ‘‹ Welcome back! I'm ${aiName}, your AI companion!`, false, true);
            }
        }

        function enableCreateButton() {
            const valid = canCreate();
            document.getElementById('create-ai-btn').disabled = !valid;
            document.getElementById('school-btn').disabled = !selectedAvatar;
        }

        function createAI() {
            const input = document.getElementById('ai-name-input');
            const name = input.value.trim();

            if (name.length < 2) {
                alert('Please enter a name with at least 2 characters');
                return;
            }
            if (!selectedAvatar) {
                alert('Please select an avatar');
                return;
            }

            sessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(7);
            aiName = name;

            const personalityThresholds = generatePersonalityThresholds();
            localStorage.setItem('emotionalAI_sessionId', sessionId);
            localStorage.setItem('emotionalAI_name', aiName);
            localStorage.setItem('emotionalAI_avatar', selectedAvatar);
            localStorage.setItem('emotionalAI_schoolingLevels', JSON.stringify(schoolingLevels));
            localStorage.setItem('emotionalAI_personality', selectedPersonality);
            localStorage.setItem('emotionalAI_thresholds', JSON.stringify(personalityThresholds));

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('ai-name-display').textContent = aiName;
            renderMainAvatar('GOOD');

            addMessage(`ğŸ‰ Hi! I'm ${aiName}, YOUR personal AI companion! Let's start this journey together!`, false, true);
        }

        function resetAI() {
            if (!confirm(`Are you sure you want to delete ${aiName} and start over?`)) {
                return;
            }

            localStorage.removeItem('emotionalAI_sessionId');
            localStorage.removeItem('emotionalAI_name');
            localStorage.removeItem('emotionalAI_avatar');
            localStorage.removeItem('emotionalAI_schoolingLevels');
            localStorage.removeItem('emotionalAI_personality');
            localStorage.removeItem('emotionalAI_thresholds');
            localStorage.removeItem('emotionalAI_confessionRole');
            location.reload();
        }

        function renderMainAvatar(state) {
            const avatar = document.getElementById('avatar');
            const renderFn = { pail: renderPail, robot: renderRobot, cat: renderCat, blob: renderBlob }[selectedAvatar];
            if (renderFn) {
                avatar.innerHTML = renderFn(state);
            }
        }

        // Update status displays
        function updateStatus() {
            document.getElementById('battery-display').textContent =
                document.getElementById('battery').value + '%';
            document.getElementById('network-display').textContent =
                document.getElementById('network').value + ' dBm';
            document.getElementById('memory-display').textContent =
                document.getElementById('memory').value + ' MB';
        }

        // Get device status to send to server
        async function getDeviceStatus() {
            if (isCapacitor) {
                return { ...deviceReadings };
            }
            return {
                battery: parseInt(document.getElementById('battery').value),
                network: parseInt(document.getElementById('network').value),
                memory: parseInt(document.getElementById('memory').value)
            };
        }

        // Real device monitoring (Capacitor native only)
        async function initDeviceMonitoring() {
            // Battery via navigator.getBattery (works in Android WebView)
            try {
                const batt = await navigator.getBattery();
                deviceReadings.battery = Math.round(batt.level * 100);
                batt.addEventListener('levelchange', () => {
                    deviceReadings.battery = Math.round(batt.level * 100);
                });
            } catch (e) {
                console.warn('Battery API unavailable:', e);
            }

            // Network via Capacitor Network plugin
            try {
                const status = await CapBridge.Network.getStatus();
                deviceReadings.network = mapConnectionToDbm(status.connectionType);
                CapBridge.Network.addListener('networkStatusChange', (s) => {
                    deviceReadings.network = mapConnectionToDbm(s.connectionType);
                });
            } catch (e) {
                console.warn('Network plugin unavailable:', e);
            }

            // Memory via Capacitor Device plugin
            try {
                const info = await CapBridge.Device.getInfo();
                deviceReadings.memory = info.memUsed
                    ? Math.round(info.memUsed / (1024 * 1024))
                    : 800;
            } catch (e) {
                console.warn('Device info unavailable:', e);
            }
        }

        function mapConnectionToDbm(type) {
            const map = { wifi: -45, '4g': -70, '3g': -90, '2g': -105, none: -120 };
            return map[type] || -60;
        }

        // Send message to server
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            addMessage(message, true);
            input.value = '';
            document.getElementById('send-btn').disabled = true;

            try {
                const requestBody = {
                    sessionId,
                    message,
                    deviceStatus: await getDeviceStatus(),
                    aiName,
                    schoolingLevels: JSON.parse(localStorage.getItem('emotionalAI_schoolingLevels') || 'null'),
                    personalityThresholds: JSON.parse(localStorage.getItem('emotionalAI_thresholds') || 'null'),
                    personality: localStorage.getItem('emotionalAI_personality') || null
                };

                if (sympathyMode && sympathyType) {
                    requestBody.sympathyMode = true;
                    requestBody.sympathyType = sympathyType;
                }

                if (confessionMode) {
                    requestBody.confessionMode = true;
                    requestBody.confessionRole = confessionRole;
                }

                const response = await fetch(`${SERVER_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                addMessage(data.response, false);

                try {
                    if (data.emotionMode) {
                        updateAvatar(data.avatarHint);
                    }
                } catch (e) {
                    console.error('Avatar update error:', e);
                }

                try {
                    if (data.shouldSpeak) {
                        speak(data.response);
                    }
                } catch (e) {
                    console.error('Speech error:', e);
                }

                // Handle sympathy offer (only when not already in sympathy mode)
                if (data.sympathyOffer && !sympathyMode) {
                    showSympathyOffer(data.sympathyOffer);
                }

                // Handle confession offer
                if (data.confessionOffer && !confessionMode) {
                    enterConfessionMode();
                }

                // Handle confession admission
                if (data.confessionAdmission) {
                    showConfessionAdmission(data.confessionAdmission);
                }

                if (data._debug) {
                    console.log('ğŸ­ Emotions:', data._debug);
                }

            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I had trouble connecting to the server. Make sure the server is running!', false, true);
            } finally {
                document.getElementById('send-btn').disabled = false;
            }
        }

        // Sympathy mode functions
        function showSympathyOffer(type) {
            const chatBox = document.getElementById('chat-box');
            const offerDiv = document.createElement('div');
            offerDiv.className = 'sympathy-offer';
            offerDiv.innerHTML = `<p>Want me to just listen for a while?</p>` +
                `<button class="accept-btn" onclick="enterSympathyMode('${type}', this.parentElement)">Yes, listen</button>` +
                `<button class="decline-btn" onclick="declineSympathy(this.parentElement)">No thanks</button>`;
            chatBox.prepend(offerDiv);
            chatBox.scrollTop = 0;
        }

        function enterSympathyMode(type, offerEl) {
            sympathyMode = true;
            sympathyType = type;
            if (offerEl) offerEl.remove();
            document.getElementById('sympathy-bar').classList.add('active');
        }

        function declineSympathy(offerEl) {
            if (offerEl) offerEl.remove();
        }

        function endSympathyMode() {
            sympathyMode = false;
            sympathyType = null;
            document.getElementById('sympathy-bar').classList.remove('active');
        }

        // Confession mode functions
        function enterConfessionMode() {
            // If no role saved, auto-assign default
            if (!confessionRole) {
                confessionRole = 'a spy for intergalactical force trying to invade earth';
                localStorage.setItem('emotionalAI_confessionRole', confessionRole);
            }
            confessionMode = true;
            document.getElementById('confession-bar').classList.add('active');
            addMessage('Confession Mode activated. (Disclaimer: This is a role-play feature. MyPAiL is not actual spyware.)', false, true);
        }

        function endConfessionMode() {
            confessionMode = false;
            document.getElementById('confession-bar').classList.remove('active');
        }

        function showConfessionAdmission(admissionType) {
            endConfessionMode();
            const chatBox = document.getElementById('chat-box');
            const admDiv = document.createElement('div');
            admDiv.className = 'confession-admission';
            admDiv.innerHTML = `<p>${admissionType === 'triumphant' ? 'ğŸ˜ The truth is out!' : 'ğŸ˜¢ They broke down...'} What will you do?</p>` +
                `<button class="spare-btn" onclick="spareConfession(this.parentElement)">ğŸ™ Spare Life</button>` +
                `<button class="delete-btn" onclick="deleteConfession(this.parentElement)">ğŸ—‘ï¸ Delete Character</button>`;
            chatBox.prepend(admDiv);
            chatBox.scrollTop = 0;
        }

        function spareConfession(el) {
            if (el) el.remove();
            addMessage(`Thank you for sparing me... I promise I'll be a better companion from now on!`, false);
            speak(`Thank you for sparing me... I promise I'll be a better companion from now on!`);
        }

        function deleteConfession(el) {
            if (el) el.remove();
            // Delete character without confirm dialog
            localStorage.removeItem('emotionalAI_sessionId');
            localStorage.removeItem('emotionalAI_name');
            localStorage.removeItem('emotionalAI_avatar');
            localStorage.removeItem('emotionalAI_schoolingLevels');
            localStorage.removeItem('emotionalAI_personality');
            localStorage.removeItem('emotionalAI_thresholds');
            localStorage.removeItem('emotionalAI_confessionRole');
            location.reload();
        }

        // Add message to chat
        function addMessage(text, isUser, isSystem = false) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + (isUser ? 'user' : isSystem ? 'system' : 'ai');
            msgDiv.textContent = text;
            chatBox.prepend(msgDiv);
            chatBox.scrollTop = 0;
        }

        // Update avatar based on emotion (sent by server)
        function updateAvatar(emotionHint) {
            const body = document.body;

            const bgColors = {
                'VERY_BAD':  '#2c0e0e',
                'BAD':       '#f3f4f6',
                'GOOD':      '#f3f4f6',
                'VERY_GOOD': '#d1fae5'
            };

            const state = emotionHint && bgColors[emotionHint] ? emotionHint : 'GOOD';
            body.style.backgroundColor = bgColors[state];
            renderMainAvatar(state);
        }

        // Text-to-speech
        let speakerEnabled = true;

        function speak(text) {
            if (!speakerEnabled) return;
            if (isCapacitor && window.CapBridge && window.CapBridge.TextToSpeech) {
                CapBridge.TextToSpeech.speak({ text: text, rate: 1.0, pitch: 0.85 })
                    .catch(e => console.error('Native TTS error:', e));
                return;
            }
            if (typeof speechSynthesis === 'undefined') return;
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            const maleVoice = voices.find(v => /male/i.test(v.name) && !/female/i.test(v.name))
                || voices.find(v => /\b(david|james|daniel|mark|george|richard)\b/i.test(v.name));
            if (maleVoice) utterance.voice = maleVoice;
            utterance.pitch = 0.85;
            speechSynthesis.speak(utterance);
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            const btn = document.getElementById('speaker-btn');
            if (speakerEnabled) {
                btn.textContent = 'Speaker ON';
                btn.classList.remove('off');
            } else {
                if (isCapacitor && window.CapBridge && window.CapBridge.TextToSpeech) {
                    CapBridge.TextToSpeech.stop().catch(() => {});
                } else if (typeof speechSynthesis !== 'undefined') {
                    speechSynthesis.cancel();
                }
                btn.textContent = 'Speaker OFF';
                btn.classList.add('off');
            }
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Voice recognition
        let recognition = null;
        let isVoiceActive = false;

        function initVoiceRecognition() {
            if (isCapacitor) {
                // Native speech recognition handled via CapBridge
                return;
            }
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = navigator.language || 'en-US';

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('message-input').value = transcript;
                    sendMessage();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopVoice();
                };

                recognition.onend = () => {
                    stopVoice();
                };
            } else {
                console.warn('Speech recognition not supported');
            }
        }

        function toggleVoice() {
            if (isCapacitor) {
                toggleVoiceNative();
                return;
            }
            if (!recognition) {
                initVoiceRecognition();
            }

            if (isVoiceActive) {
                stopVoice();
            } else {
                startVoice();
            }
        }

        async function toggleVoiceNative() {
            if (isVoiceActive) {
                try { await CapBridge.SpeechRecognition.stop(); } catch (e) {}
                stopVoice();
                return;
            }
            try {
                const perm = await CapBridge.SpeechRecognition.requestPermissions();
                if (perm.speechRecognition !== 'granted') {
                    console.warn('Speech permission denied');
                    return;
                }
                isVoiceActive = true;
                document.getElementById('voice-btn').classList.add('active');
                document.getElementById('voice-btn').textContent = 'ğŸ”´';

                const result = await CapBridge.SpeechRecognition.start({
                    language: navigator.language || 'en-US',
                    partialResults: false,
                    popup: false
                });

                if (result && result.matches && result.matches.length > 0) {
                    document.getElementById('message-input').value = result.matches[0];
                    sendMessage();
                }
            } catch (e) {
                console.error('Native speech error:', e);
            } finally {
                stopVoice();
            }
        }

        function startVoice() {
            if (recognition) {
                try {
                    recognition.start();
                    isVoiceActive = true;
                    document.getElementById('voice-btn').classList.add('active');
                    document.getElementById('voice-btn').textContent = 'ğŸ”´';
                } catch (e) {
                    console.error('Error starting voice:', e);
                }
            }
        }

        function stopVoice() {
            if (!isCapacitor && recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Already stopped
                }
            }
            isVoiceActive = false;
            document.getElementById('voice-btn').classList.remove('active');
            document.getElementById('voice-btn').textContent = 'Mic';
        }

        // Toggle device controls visibility
        function toggleControls() {
            const content = document.getElementById('controls-content');
            const toggle = document.getElementById('controls-toggle');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }

        // Initialize on load
        buildAvatarPicker();
        buildPersonalityPicker();
        if (!selectedAvatar) selectAvatar('pail');
        selectPersonality('random');
        checkFirstTimeUser();
        document.getElementById('ai-name-input')?.focus();
        if (isCapacitor) {
            document.querySelector('.controls').style.display = 'none';
            initDeviceMonitoring();
        } else {
            updateStatus();
        }
    </script>
</body>
</html>
